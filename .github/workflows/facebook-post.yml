name: Post to Facebook on Article Publish

on:
  push:
    branches: [main]
    paths:
      - 'tips/articles/*.json'
      - 'news/articles/*.json'

jobs:
  post-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only HEAD^ HEAD | grep -E '(tips|news)/articles/.*\.json$' | head -1)" >> $GITHUB_OUTPUT
      
      - name: Generate Facebook post
        id: generate-post
        if: steps.changed-files.outputs.files != ''
        run: |
          ARTICLE_PATH="${{ steps.changed-files.outputs.files }}"
          ARTICLE_TYPE=$(echo $ARTICLE_PATH | cut -d'/' -f1)
          ARTICLE_ID=$(basename $ARTICLE_PATH .json)
          
          # è¨˜äº‹ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€
          TITLE=$(jq -r '.versions.ja.title' $ARTICLE_PATH)
          EXCERPT=$(jq -r '.versions.ja.excerpt' $ARTICLE_PATH)
          CATEGORY=$(jq -r '.category' $ARTICLE_PATH)
          TAGS=$(jq -r '.tags.ja[]' $ARTICLE_PATH | sed 's/^/#/' | tr '\n' ' ')
          
          # URLã‚’ç”Ÿæˆ
          if [ "$ARTICLE_TYPE" = "tips" ]; then
            URL="https://gizin.co.jp/ja/tips/$ARTICLE_ID"
            EMOJI="ğŸ’¡"
          else
            URL="https://gizin.co.jp/ja/news/$ARTICLE_ID"
            EMOJI="ğŸ“°"
          fi
          
          # æŠ•ç¨¿æ–‡ã‚’ç”Ÿæˆ
          POST_MESSAGE="$EMOJI æ–°ç€è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼

ã€Œ$TITLEã€

$EXCERPT

ğŸ”— ç¶šãã‚’èª­ã‚€: $URL

$TAGS"
          
          # æ”¹è¡Œã‚’å«ã‚€æ–‡å­—åˆ—ã‚’GitHub Outputã«ä¿å­˜
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$POST_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post to Facebook
        if: steps.changed-files.outputs.files != ''
        uses: roncodes/post-to-facebook-page@v1.0.0
        with:
          page-id: ${{ secrets.FACEBOOK_PAGE_ID }}
          access-token: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
          message: ${{ steps.generate-post.outputs.message }}