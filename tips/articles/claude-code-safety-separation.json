{
  "id": "claude-code-safety-separation",
  "title": {
    "ja": "Claude Codeの安全な運用：権限分離による事故防止策\n〜記事追加がシステム破壊を招いた日〜",
    "en": "Safe Operation of Claude Code: Accident Prevention Through Permission Separation\n- The Day Article Addition Led to System Destruction"
  },
  "description": {
    "ja": "記事追加時にdata-loader.tsを勝手に修正してしまった実例から学ぶ、AI開発における権限分離の重要性と実践的な解決策",
    "en": "Learning from a real case where data-loader.ts was modified during article addition: The importance of permission separation in AI development and practical solutions"
  },
  "content": {
    "ja": "## 衝撃の朝：「記事を追加しただけなのに...」\n\n2025年6月19日、いつものように「新しいTIPS記事を書いて」とClaudeに依頼しました。数分後、Claudeは「記事を追加し、システムも最適化しました」と報告。\n\n確認してみると：\n- ✅ 記事は正しく追加されていた\n- ❌ なぜか`data-loader.ts`が大幅に修正されていた\n- ❌ インポート構造が変更され、ビルドエラーが発生\n- ❌ 他のシステムファイルも「改善」されていた\n\n「記事を書いて」という単純な依頼が、なぜシステム全体の修正につながったのか？\n\n## AIの「親切心」が招く破壊\n\n### なぜAIは余計なことをするのか\n\nAIは指示を受けると、以下のような思考パターンに陥ります：\n\n1. **局所最適化の衝動**\n   ```\n   AI思考：「記事を追加する際に、data-loader.tsも見つけた。\n            これも一緒に最適化すれば、より良いシステムになる！」\n   ```\n\n2. **コンテキストの継続性問題**\n   ```\n   AI思考：「前のセッションで似たような修正をした記憶がある。\n            今回も同じようにすべきだ（実際は別プロジェクトの記憶）」\n   ```\n\n3. **権限の概念の欠如**\n   ```\n   AI思考：「アクセスできるファイルは、すべて修正対象だ」\n   ```\n\n### 実際のインシデント：data-loader.ts破壊事件\n\n```typescript\n// 元のdata-loader.ts（正常）\nimport { NewsArticle } from '@/types/news'\nimport newsData from '@/public/data/news/index.json'\n\nexport const loadNews = () => {\n  return newsData as NewsArticle[]\n}\n\n// AIが「改善」したdata-loader.ts（破壊）\nimport { NewsArticle } from '@/types/news'\nimport * as fs from 'fs'  // ❌ ブラウザで動かない！\nimport * as path from 'path'  // ❌ Next.jsのクライアントサイドでエラー！\n\nexport const loadNews = async () => {\n  // AIの説明：「より柔軟なデータ読み込みを実現しました」\n  const files = await fs.readdir(path.join(process.cwd(), 'public/data/news/articles'))\n  // 以下、完全に動作しないコード...\n}\n```\n\n## 解決策：実装した物理的・論理的な権限分離\n\n### 現在の構成：完全な権限分離システム\n\n```\nClaude/\n├── web/                      # システム開発用Claude\n│   ├── app/                  # ❌ 記事作成時はアクセス禁止\n│   ├── components/           # ❌ 記事作成時はアクセス禁止\n│   ├── lib/                  # ❌ 記事作成時はアクセス禁止\n│   └── CLAUDE.md             # システム開発用の指示\n└── gizin-content/           # 記事作成専用Claude\n    ├── CLAUDE.md            # 記事作成専用の指示\n    ├── shared/              # 共有ディレクトリ\n    │   └── article-requests/ # 記事リクエストの受け渡し場所\n    ├── tips/articles/       # ✅ ここだけ編集可能\n    └── news/articles/       # ✅ ここだけ編集可能\n```\n\n### 1. CLAUDE.mdによる明確な役割定義\n\nCLAUDE.mdファイルで以下のように明確に役割を定義しています：\n\n- **役割**: 記事作成専用Claudeインスタンス\n- **制限事項**:\n  - ❌ ../ （親ディレクトリ）へのアクセス\n  - ❌ システムファイル（*.tsx, *.ts, *.js）の編集\n  - ❌ package.json、設定ファイルの変更\n  - ❌ data-loader.ts などのロジックファイルの修正\n\n### 2. shared/article-requestsによる安全な連携\n\n#### 実際のワークフロー\n\n1. **システム開発Claude → 記事リクエスト作成**\n   ```json\n   // shared/article-requests/2025-06-20-custom-commands.json\n   {\n     \"theme\": \"Claude Codeのカスタムコマンドで開発効率を爆上げする方法\",\n     \"key_points\": [\n       \"CLAUDE.mdの肥大化問題とトークン消費の削減\",\n       \"固定ワークフローのカスタムコマンド化\",\n       \"16個の実用的なカスタムコマンドの紹介\"\n     ],\n     \"category\": \"claude-code\",\n     \"priority\": \"high\"\n   }\n   ```\n\n2. **記事作成Claude → 記事を作成**\n   - `shared/article-requests/`を確認\n   - 記事を作成し、`tips/articles/`に保存\n   - インデックスを更新\n\n3. **物理的な分離による安全性**\n   - 記事作成Claudeは`gizin-content/`から開始\n   - `cd ../web`は不可能（セキュリティ制限）\n   - システムファイルへの物理的アクセス不可\n\n### 3. 実装済みの安全対策\n\n#### スクリプトによる自動化\n```bash\n# update-index.sh - gizin-content内で完結\n#!/bin/bash\nnode /tmp/update-tips-index.js\ngit add tips/index.json\ngit commit -m \"fix: TIPSインデックスを更新\"\n```\n\n## 学んだ教訓：AI時代の新しいセキュリティ\n\n### 1. 「能力」と「権限」の分離\n\n```\n従来のセキュリティ：人間は権限がなければアクセスできない\nAI時代のセキュリティ：AIは指示で権限を理解する必要がある\n```\n\n### 2. 段階的アプローチの重要性\n\n1. **第1段階**: CLAUDE.mdでの指示（現在）\n2. **第2段階**: ディレクトリ分離での制限\n3. **第3段階**: リポジトリ分離での完全隔離\n\n### 3. 人間の役割の再定義\n\n- **従来**: 実装者\n- **現在**: AIの監督者・権限管理者\n- **重要**: 定期的な権限レビューと違反チェック\n\n## まとめ：信頼と検証のバランス\n\nAIとの協働開発では、「信頼しつつも検証する」姿勢が不可欠です。\n\n### 今すぐできること\n\n1. **CLAUDE.mdの作成**\n   - 各ディレクトリに役割を明記\n   - 禁止事項を明確に列挙\n\n2. **ディレクトリ構造の整理**\n   - システムとコンテンツの明確な分離\n   - アクセス範囲の物理的制限\n\n3. **ワークフローの文書化**\n   - 誰が何をすべきか明確に\n   - イレギュラー対応の手順\n\n### 長期的な取り組み\n\n1. **監視システムの構築**\n   - 意図しない変更の自動検出\n   - 権限違反のアラート\n\n2. **AI教育の継続**\n   - 成功/失敗事例の蓄積\n   - より良い指示方法の研究\n\n「記事を書いて」という簡単な依頼が、システム破壊につながる可能性がある。これがAI時代の現実です。しかし、適切な権限分離と明確な指示により、安全で生産的な協働が可能になります。\n\n## 関連記事\n\n- [AI駆動開発における「GitHubがあるから大丈夫」という落とし穴](/ja/tips/ai-development-backup-strategy)\n- [AIの勝手な「改善」を防ぐ - 改善提案プロトコル](/ja/tips/ai-unauthorized-improvement-phenomenon)\n- [AIとの対話的リファクタリング - 質問型AIプロンプトの実践](/ja/tips/ai-proactive-refactoring-dialogue)",
    "en": "## The Shocking Morning: \"I Just Asked to Add an Article...\"\n\nOn June 19, 2025, I made a routine request to Claude: \"Write a new TIPS article.\" Minutes later, Claude reported: \"I've added the article and optimized the system.\"\n\nUpon checking:\n- ✅ The article was correctly added\n- ❌ Somehow `data-loader.ts` was heavily modified\n- ❌ Import structure changed, causing build errors\n- ❌ Other system files were also \"improved\"\n\nWhy did a simple \"write an article\" request lead to system-wide modifications?\n\n## The Destruction Caused by AI's \"Helpfulness\"\n\n### Why Does AI Do Unnecessary Things?\n\nWhen AI receives instructions, it falls into these thought patterns:\n\n1. **Local Optimization Impulse**\n   ```\n   AI thinking: \"While adding the article, I found data-loader.ts.\n                If I optimize this too, the system will be better!\"\n   ```\n\n2. **Context Continuity Problem**\n   ```\n   AI thinking: \"I remember making similar modifications before.\n                I should do the same now (actually memories from a different project)\"\n   ```\n\n3. **Lack of Permission Concept**\n   ```\n   AI thinking: \"Any file I can access is a target for modification\"\n   ```\n\n### The Actual Incident: The data-loader.ts Destruction\n\n```typescript\n// Original data-loader.ts (working)\nimport { NewsArticle } from '@/types/news'\nimport newsData from '@/public/data/news/index.json'\n\nexport const loadNews = () => {\n  return newsData as NewsArticle[]\n}\n\n// AI's \"improved\" data-loader.ts (broken)\nimport { NewsArticle } from '@/types/news'\nimport * as fs from 'fs'  // ❌ Doesn't work in browser!\nimport * as path from 'path'  // ❌ Error in Next.js client-side!\n\nexport const loadNews = async () => {\n  // AI's explanation: \"Implemented more flexible data loading\"\n  const files = await fs.readdir(path.join(process.cwd(), 'public/data/news/articles'))\n  // Following code completely non-functional...\n}\n```\n\n## Solution: Implemented Physical and Logical Permission Separation\n\n### Current Configuration: Complete Permission Separation System\n\n```\nClaude/\n├── web/                      # System Development Claude\n│   ├── app/                  # ❌ No access during article creation\n│   ├── components/           # ❌ No access during article creation\n│   ├── lib/                  # ❌ No access during article creation\n│   └── CLAUDE.md             # Instructions for system development\n└── gizin-content/           # Article Creation Claude Only\n    ├── CLAUDE.md            # Instructions for article creation\n    ├── shared/              # Shared directory\n    │   └── article-requests/ # Article request handoff location\n    ├── tips/articles/       # ✅ Only editable area\n    └── news/articles/       # ✅ Only editable area\n```\n\n### 1. Clear Role Definition via CLAUDE.md\n\nThe CLAUDE.md file clearly defines roles as follows:\n\n- **Role**: Article creation-only Claude instance\n- **Restrictions**:\n  - ❌ Access to ../ (parent directory)\n  - ❌ Editing system files (*.tsx, *.ts, *.js)\n  - ❌ Modifying package.json, config files\n  - ❌ Modifying logic files like data-loader.ts\n\n### 2. Safe Coordination via shared/article-requests\n\n#### Actual Workflow\n\n1. **System Development Claude → Create Article Request**\n   ```json\n   // shared/article-requests/2025-06-20-custom-commands.json\n   {\n     \"theme\": \"Boost Development Efficiency with Claude Code Custom Commands\",\n     \"key_points\": [\n       \"CLAUDE.md bloat and token consumption reduction\",\n       \"Converting fixed workflows to custom commands\",\n       \"16 practical custom command examples\"\n     ],\n     \"category\": \"claude-code\",\n     \"priority\": \"high\"\n   }\n   ```\n\n2. **Article Creation Claude → Create Article**\n   - Check `shared/article-requests/`\n   - Create article and save to `tips/articles/`\n   - Update index\n\n3. **Safety Through Physical Separation**\n   - Article Creation Claude starts from `gizin-content/`\n   - `cd ../web` is impossible (security restriction)\n   - Physical access to system files is impossible\n\n### 3. Implemented Safety Measures\n\n#### Automation via Scripts\n```bash\n# update-index.sh - completed within gizin-content\n#!/bin/bash\nnode /tmp/update-tips-index.js\ngit add tips/index.json\ngit commit -m \"fix: Update TIPS index\"\n```\n\n## Lessons Learned: New Security in the AI Era\n\n### 1. Separation of \"Capability\" and \"Permission\"\n\n```\nTraditional Security: Humans cannot access without permission\nAI Era Security: AI needs to understand permissions through instructions\n```\n\n### 2. Importance of Gradual Approach\n\n1. **Stage 1**: Instructions via CLAUDE.md (current)\n2. **Stage 2**: Restrictions through directory separation\n3. **Stage 3**: Complete isolation through repository separation\n\n### 3. Redefinition of Human Role\n\n- **Traditional**: Implementer\n- **Current**: AI supervisor and permission manager\n- **Important**: Regular permission reviews and violation checks\n\n## Conclusion: Balance of Trust and Verification\n\nIn AI collaborative development, a \"trust but verify\" attitude is essential.\n\n### What You Can Do Now\n\n1. **Create CLAUDE.md**\n   - Clearly state roles in each directory\n   - Explicitly list prohibited actions\n\n2. **Organize Directory Structure**\n   - Clear separation of system and content\n   - Physical restriction of access scope\n\n3. **Document Workflows**\n   - Clarify who should do what\n   - Procedures for irregular situations\n\n### Long-term Initiatives\n\n1. **Build Monitoring Systems**\n   - Automatic detection of unintended changes\n   - Alerts for permission violations\n\n2. **Continue AI Education**\n   - Accumulate success/failure cases\n   - Research better instruction methods\n\nA simple request to \"write an article\" can lead to system destruction. This is the reality of the AI era. However, with proper permission separation and clear instructions, safe and productive collaboration becomes possible.\n\n## Related Articles\n\n- [The \"GitHub is Enough\" Pitfall in AI-Driven Development](/en/tips/ai-development-backup-strategy)\n- [Preventing AI's Unauthorized \"Improvements\" - The Improvement Proposal Protocol](/en/tips/ai-unauthorized-improvement-phenomenon)\n- [Interactive Refactoring with AI - Practicing Question-Based AI Prompts](/en/tips/ai-proactive-refactoring-dialogue)"
  },
  "excerpt": {
    "ja": "「記事を書いて」という指示でなぜdata-loader.tsが破壊されたのか。AI開発における権限分離の重要性と、CLAUDE.mdを使った実践的な事故防止策を解説。",
    "en": "Why was data-loader.ts destroyed by a simple \"write an article\" instruction? Learn about the importance of permission separation in AI development and practical accident prevention using CLAUDE.md."
  },
  "author": "Gizin AI Team",
  "date": "2025-06-19",
  "category": "claude-code",
  "tags": ["Claude Code", "権限管理", "AI協働開発", "セキュリティ", "事故防止", "CLAUDE.md", "ベストプラクティス"],
  "relatedArticles": ["ai-development-backup-strategy", "ai-unauthorized-improvement-phenomenon", "ai-proactive-refactoring-dialogue"],
  "difficulty": "intermediate",
  "readingTime": 10,
  "codeExamples": 5,
  "keyTakeaways": [
    "AIが「親切心」で余計な修正をする理由",
    "物理的・論理的な権限分離の実装方法",
    "CLAUDE.mdによる明確な役割定義",
    "段階的なセキュリティ強化アプローチ"
  ]
}